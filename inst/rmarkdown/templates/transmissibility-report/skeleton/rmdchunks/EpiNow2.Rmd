## _EpiNow2_ 

```{r}
pacman::p_load("EpiNow2")
```

### Explanations

### Results

```{r}
# Approximate serial interval with gamma distribution since this is what EpiNow2
# will use for generation_time
si_gamma <- epiparameter::extract_param(
  type = "range",
  values = c(median(si$r(1e3)), min(si$r(1e3)), max(si$r(1e3))),
  distribution = "gamma",
  samples = 1e3
)
si_gamma <- epiparameter::gamma_shapescale2meansd(si_gamma[[1]], si_gamma[[2]])

generation_time <- list(
  mean = si_gamma$mean,
  mean_sd = 0,
  sd = si_gamma$sd,
  sd_sd = 0,
  max = max(si_x)
)
```

#### Global transmissibility

These analyses present results for the global incidence, i.e. without
stratification. Results include:
 
* a graph of the estimates of $R_t$ over time, with associated 95% credibility
  intervals
  
* a table summarising these results for the last two weeks

```{r}
dat_i_day <- dat_raw %>%
  incidence("date",
    interval = 1L,
    counts = {{ count_var }},
    groups = {{ group_var }}
  )

# Warning, this step will take 2 cores of your computer and may be running
# for a long time!
rt_epinow2 <- dat_i_day %>%
  regroup() %>%
  dplyr::rename(
    confirm = .data[[count_var]],
    date    = date_index
  ) %>%
  epinow(
    generation_time = generation_time,
    stan = stan_opts(samples = 1e3, chains = 2),
    rt = rt_opts(gp_on = "R0"),
    horizon = 0,
    CrIs = c(0.5, 0.95),
    return_output = TRUE,
    verbose = FALSE,
    logs = NULL
  )
```

```{r}
plot(rt_epinow2, "R") +
  scale_x_date(breaks = scales::pretty_breaks(n = 8), date_label = "%d %b %Y") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
  labs(
    x = "",
    y = "Instantaneous reproduction number (Rt)",
    title = "Estimates of Rt (EpiNow2)"
  )
```

```{r}
rt_epinow2$estimates$summarised %>%
  dplyr::filter(variable == "R") %>%
  tail(14) %>%
  dplyr::select(date, mean, median, lower_95, upper_95) %>%
  mutate(
    "mean $R$" = round(mean, 2),
    "median $R$" = round(median, 2),
    "95% ci" = sprintf(
      "[%1.2f ; %1.2f]",
      lower_95,
      upper_95
    ),
    .keep = "unused"
  ) %>%
  kbl() %>%
  kable_paper("striped", font_size = 18, full_width = FALSE) %>%
  row_spec((1:14)[c(FALSE, TRUE)],
    background = pale_green
  )
```

#### Transmissibility by group

```{r epinow2 with epiparameter, message = FALSE}
rt_by_group <- dat_i_day %>%
  dplyr::rename(
    confirm = .data[[count_var]],
    date    = date_index,
    region  = .data[[group_var]]
  ) %>%
  regional_epinow(
    generation_time = generation_time,
    stan = stan_opts(samples = 1e3, chains = 2),
    rt = rt_opts(gp_on = "R0"),
    horizon = 0,
    CrIs = c(0.5, 0.95),
    return_output = TRUE,
    verbose = FALSE,
    logs = NULL
  )
```

```{r}
rt_by_group$summary$plots$R
```

```{r}
rt_by_group$summary$summarised_results$data %>%
  dplyr::filter(metric == "Effective reproduction no.") %>%
  dplyr::select(region, mean, median, lower_95, upper_95) %>%
  dplyr::mutate(
    "95% ci" = sprintf(
      "[%1.2f ; %1.2f]",
      lower_95,
      upper_95
    ),
    .keep = "unused"
  ) %>%
  kbl() %>%
  kable_paper("striped", font_size = 18, full_width = FALSE) %>%
  row_spec((1:n_groups)[c(FALSE, TRUE)],
    background = pale_green
  )
```
