<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="episoap">
<title>List of included pipelines â€¢ episoap</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="List of included pipelines">
<meta property="og:description" content="episoap">
<meta property="og:image" content="https://epiverse-trace.github.io/episoap/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Google tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XZ471458FQ"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XZ471458FQ');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-dark"><div class="container">
    
    <a href="https://epiverse-trace.github.io/" class="external-link"><img src="../logo_white.svg" id="logo" alt="Epiverse-TRACE"></a>
    <a class="navbar-brand me-2" href="../index.html">episoap</a>

    <small class="nav-text text-muted me-auto version-number" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/episoap.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/pipelines.html">List of included pipelines</a>
    <a class="dropdown-item" href="../articles/design.html">Design principles</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/epiverse-trace/episoap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>List of included pipelines</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/epiverse-trace/episoap/blob/HEAD/vignettes/articles/pipelines.Rmd" class="external-link"><code>vignettes/articles/pipelines.Rmd</code></a></small>
      <div class="d-none name"><code>pipelines.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 class="tabset" id="section"></h2>
<div class="section level3">
<h3 id="transmissibility-pipeline">Transmissibility pipeline<a class="anchor" aria-label="anchor" href="#transmissibility-pipeline"></a>
</h3>
<p>A template for estimating transmissibility (i.e., how fast a disease
spreads) from a stratified population. It performs basic descriptive
analyses, and uses different approaches for estimating
transmissibility.</p>
<p><img src="transmissibility_pipeline.svg"><!-- --></p>
<pre><code>---
title: "Estimating transmissibility with population stratification"
author: Thibaut Jombart, Hugo Gruson
date: "`r Sys.Date()`"
output:
  rmarkdown::html_document:
    code_folding: "hide"
link-citations: no
params:
  epicurve_unit: 
    label: "An integer or character indicating the (fixed) size of the time interval used for computing the incidence. Passed as the `interval` argument in `incidence2::incidence()`."
    value: "week"
  incomplete_days: 
    label: "Number of days to exclude from the estimation of Rt since data is likely to still be incomplete."
    value: 7
  r_estim_window:
    label: "Number of days to include to get the latest observed value of Rt."
    value: 21
  use_epiparameter: 
    label: "Should the serial interval distribution be extracted directly from the epiparameter package?"
    value: FALSE
  epiparameter_pathogen: 
    label: "Name of the pathogen in the epiparameter database if `use_parameter = TRUE`."
    value: "SARS_CoV_2_wildtype"
  si_mean:
    label: "Mean of the distribution for serial interval if not using value from epiparameter. Ignored if `use_epiparameter = TRUE`."
    value: 4.2
  si_sd: 
    label: "Standard deviation of the distribution for serial interval if not using value from epiparameter. Ignored if `use_epiparameter = TRUE`."
    value: 4.9
  si_dist: 
    label: "Choice of probability distribution for serial interval if not using value from epiparameter. Ignored if `use_epiparameter = TRUE`."
    value: "gamma"
    choices: ["beta", "binom", "cauchy", "chisq", "exp", "f", "gamma", "geom", "hyper", "lnorm", "logis", "nbinom", "norm", "pois", "smirnov", "t", "tukey", "unif", "weibull", "wilcox"]
  data_file: 
    label: "Name of file containing the count data over time"
    value: "data/covid_hosp_uk_20201024.xlsx"
    input: file
  rt_estimator: 
    label: "Which R package to use for Rt estimation"
    value: "i2extras"
    choices: ["EpiEstim", "EpiNow2", "i2extras", "R0"]
bibliography: 
  - grateful-refs.bib
---

```{r lockfile, include = FALSE, message = FALSE}
renv::use(
  "MASS@7.3-59",
  "Matrix@1.6-3",
  "R.methodsS3@1.8.2",
  "R.oo@1.25.0",
  "R.utils@2.12.3",
  "R6@2.5.1",
  "RColorBrewer@1.1-3",
  "Rcpp@1.0.11",
  "askpass@1.2.0",
  "backports@1.4.1",
  "base64enc@0.1-3",
  "bit64@4.0.5",
  "bit@4.0.5",
  "bslib@0.6.1",
  "cachem@1.0.8",
  "callr@3.7.3",
  "cellranger@1.1.0",
  "checkmate@2.3.0",
  "cli@3.6.1",
  "clipr@0.8.0",
  "colorspace@2.1-0",
  "commonmark@1.9.0",
  "cpp11@0.4.7",
  "crayon@1.5.2",
  "curl@5.1.0",
  "data.table@1.14.8",
  "digest@0.6.33",
  "distcrete@1.0.3",
  "distributional@0.3.2",
  "dplyr@1.1.4",
  "ellipsis@0.3.2",
  "epiverse-trace/episoap", # nolint
  "epitrix@0.4.0",
  "epiverse-trace/epiparameter@fd250ce", # nolint 
  "evaluate@0.23",
  "fansi@1.0.5",
  "farver@2.1.1",
  "fastmap@1.1.1",
  "fontawesome@0.5.2",
  "forcats@1.0.0",
  "foreign@0.8-85",
  "fs@1.6.3",
  "generics@0.1.3",
  "ggplot2@3.5.0",
  "glue@1.6.2",
  "grateful@0.2.4",
  "grates@1.1.0",
  "gtable@0.3.4",
  "haven@2.5.3",
  "highr@0.10",
  "hms@1.1.3",
  "htmltools@0.5.7",
  "httpuv@1.6.12",
  "httr@1.4.7",
  "incidence2@2.2.3",
  "isoband@0.2.7",
  "janitor@2.2.0",
  "jquerylib@0.1.4",
  "jsonlite@1.8.7",
  "kableExtra@1.3.4",
  "knitr@1.45",
  "labeling@0.4.3",
  "later@1.3.1",
  "lattice@0.21-8",
  "lifecycle@1.0.4",
  "linelist@1.0.0",
  "lubridate@1.9.3",
  "magrittr@2.0.3",
  "memoise@2.0.1",
  "mgcv@1.9-0",
  "mime@0.12",
  "munsell@0.5.0",
  "nlme@3.1-163",
  "numDeriv@2016.8-1.1",
  "openssl@2.1.1",
  "pillar@1.9.0",
  "pkgconfig@2.0.3",
  "prettyunits@1.2.0",
  "processx@3.8.2",
  "progress@1.2.2",
  "promises@1.2.1",
  "ps@1.7.5",
  "purrr@1.0.2",
  "rappdirs@0.3.3",
  "readr@2.1.4",
  "readxl@1.4.3",
  "rematch@2.0.0",
  "remotes@2.4.2.1",
  "renv@1.0.3",
  "rio@1.0.1",
  "rlang@1.1.2",
  "rmarkdown@2.25",
  "rstudioapi@0.15.0",
  "rvest@1.0.3",
  "sass@0.4.7",
  "scales@1.3.0",
  "selectr@0.4-2",
  "shiny@1.8.0",
  "snakecase@0.11.1",
  "sodium@1.3.1",
  "sourcetools@0.1.7-1",
  "stringi@1.8.2",
  "stringr@1.5.1",
  "svglite@2.1.2",
  "sys@3.4.2",
  "systemfonts@1.0.5",
  "tibble@3.2.1",
  "tidyr@1.3.0",
  "tidyselect@1.2.0",
  "timechange@0.2.0",
  "tinytex@0.49",
  "tzdb@0.4.0",
  "utf8@1.2.4",
  "vctrs@0.6.5",
  "viridisLite@0.4.2",
  "vroom@1.6.4",
  "webshot@0.5.5",
  "withr@2.5.2",
  "writexl@1.4.2",
  "xfun@0.41",
  "xml2@1.3.5",
  "xtable@1.8-4",
  "yaml@2.3.7"
)
```

```{r settings, echo = FALSE}
knitr::opts_chunk$set(
  fig.width = 9,
  fig.height = 5,
  dpi = 90,
  collapse = TRUE,
  message = FALSE,
  warning = FALSE,
  out.width = "100%"
)
```

# Outline of the report

## Estimating transmissibility from stratified population

This report provides a template for estimating transmissibility (i.e., how fast
a disease spreads) from a stratified population. It performs basic descriptive
analyses, and uses different approaches for estimating transmissibility. The key
steps of the report include:

* importing the data from an external file
* identifying key variables in the data
* producing global and stratified epidemic curves
* estimating the growth rate and doubling time from epidemic curves
* estimating the instantaneous reproduction number from epidemic curves

```{r}
knitr::include_graphics("transmissibility_pipeline.svg")
```

# Data preparation

## Loading libraries

The following code loads required packages; missing packages will be installed
automatically, but will require a working internet connection for the
installation to be successful.

```{r}
library(dplyr)
library(ggplot2)
library(forcats)
library(purrr)
library(tidyr)
library(rio)
library(linelist)
library(janitor)
library(kableExtra)
library(incidence2)
library(distcrete)
library(epitrix)
library(grateful)
library(epiparameter)

# episoap is already installed since this is where this document comes from
library(episoap)
```

```{r}
custom_grey &lt;- "#505B5B"
green_grey &lt;- "#5E7E80"
pale_green &lt;- "#B2D1CC"
dark_green &lt;- "#005C5D"
dark_pink &lt;- "#B45D75"

theme_set(theme_episoap())
```

&lt;!--
### System dependencies

You may need to install system dependencies to be able to generate this report:

```sh
# macOS
brew install libsodium cmake

# Linux (Debian based)
apt install libsodium-dev cmake
```
--&gt;

##  Importing the data

To illustrate the different analyses, we use real data reporting daily numbers
of COVID-19 hospitalisations in England as of the 24 October 2020, broken down
to the hospital and National Health Service (NHS) region level. The data is
available online from the NHS England's
[website](https://www.england.nhs.uk/statistics/statistical-work-areas/covid-19-hospital-activity/).
The dataset analysed here is a simplified version, providing incidence of
hospital admissions by NHS trust.

The data file is named "*covid_hosp_uk_20201024.xlsx*" and is located in
the *data/* folder. To adapt this report to another dataset, change the name of
the file in the `data_file` parameter at the top of this document.

```{r}
data_path &lt;- params$data_file
```

```{r}
dat_raw &lt;- data_path %&gt;%
  rio::import() %&gt;%
  tibble() %&gt;%
  # rio (via readxl) tends to use POSIXct for what is encoded as Date in the
  # original data file.
  # But POSIXct is not a good format to work with dates, as discussed in
  # https://github.com/reconverse/incidence2/issues/105
  mutate(across(where(\(x) inherits(x, "POSIXct")), as.Date))
```

Once imported into __R__, the dataset called `dat` includes:

* `date`: the date of admission
* `region`: the NHS region
* `org_name`: the full name of the NHS trust
* `org_code`: a short code for the NHS trust
* `n`: number of new, confirmed COVID-19 cases admitted, including inpatients
  who tested positive on that day, and new admissions with a positive test

## Identifying key data

__Note__: this is not used for now, as there is no integration of linelist with
other existing tools.

Here we identify the key data needed in the analyses, including:

* the dates to be used, here, dates of hospital admission
* the strata of the population, here, coarse geographic locations (NHS regions)
* the case counts; this would not be needed if the data was a raw linelist, and
  not already aggregated counts

```{r}
date_var &lt;- "date"
group_var &lt;- "region"
count_var &lt;- "n"

dat &lt;- dat_raw %&gt;%
  make_linelist(
    date_admission = date_var,
    location = group_var,
    counts = count_var,
    allow_extra = TRUE
  )
```

# Descriptive analyses

## Epidemic curves

This section creates epidemic curves ("_epicurves_"), with or without stratification.

```{r}
# convert daily incidence into weekly incidence using incidence2
dat_i &lt;- dat_raw %&gt;%
  incidence("date",
    interval = params$epicurve_unit,
    counts = count_var,
    groups = group_var
  )

# general variables for automatic customisation of plots
n_groups &lt;- dplyr::n_distinct(get_groups(dat_i)[[1]])
small_counts &lt;- max(get_count_value(dat_i)) &lt; 20
```

```{r fig.height = 5 / 3 * n_groups}
dat_i %&gt;%
  plot(alpha = 1, nrow = n_groups) +
  labs(title = "Incidence of cases over time")
```

## Numbers of cases

This graph shows the total number of cases per group:

```{r }
total_cases &lt;- dat %&gt;%
  tags_df() %&gt;%
  select(location, counts) %&gt;%
  group_by(location) %&gt;%
  summarise(cases = sum(counts)) %&gt;%
  mutate(location = fct_reorder(
    .f = location,
    .x = cases
  ))

ggplot(total_cases, aes(x = cases, y = location)) +
  geom_col(fill = green_grey) +
  labs(x = "Total number of cases", y = NULL)

total_cases %&gt;%
  mutate(
    percentage = sprintf("%.2f%%", cases / sum(cases) * 100)
  ) %&gt;%
  adorn_totals() %&gt;%
  mutate(cases = format(cases, scientific = FALSE, big.mark = " ")) %&gt;%
  set_names(toupper) %&gt;%
  kbl() %&gt;%
  kable_paper("striped", font_size = 18, full_width = FALSE)
```


# Serial interval distribution

## Explanations

The _serial interval_ ($si$) is the delay between the date of symptom onsets of primary
case and the secondary cases they have infected. Because this delay varies from
one transmission pair to another, we will characterise this variation using a
probability distribution. This distribution is a key input to methods use for
estimating the reproduction number ($R$). 

Here, we assume that the mean and standard deviation of the $si$ is known, and
provided as an input by the user. We model the $si$ distribution as a
discretized Gamma. 

## Results

```{r, eval = params$use_epiparameter}
si_epiparameter &lt;- epiparameter::epidist(
  params$epiparameter_pathogen,
  "serial_interval"
)
si_params &lt;- si_epiparameter$param
si_dist &lt;- si_epiparameter$dist
si_mean &lt;- si_params[[1]]
si_sd &lt;- si_params[[2]]
```

```{r, eval = !params$use_epiparameter}
si_mean &lt;- params$si_mean
si_sd &lt;- params$si_sd
si_dist &lt;- params$si_dist
si_cv &lt;- si_sd / si_mean
si_params &lt;- epitrix::gamma_mucv2shapescale(mu = si_mean, cv = si_cv)
```

```{r}
# do.call() because we want to pass `si_params` names as the name of arguments.
# This is important if params in si_params are not the first arguments of the
# q...() function. For example, if a gamma distribution is define by its shape
# and scale, instead of shape and rate.
si &lt;- do.call(
  distcrete,
  c(
    list(si_dist,
      interval = 1,
      w = 0
    ),
    si_params
  )
)
si_x &lt;- seq(1L, to = si$q(0.999), by = 1L)
```

```{r}
ggplot(
  data.frame(delay = si_x, prob = si$d(si_x)),
  aes(x = delay, y = prob)
) +
  geom_col(fill = green_grey) +
  labs(
    title = "Serial interval distribution",
    x = "Days from primary to secondary onset",
    y = "Probability",
    subtitle = sprintf(
      "%s distribution | mean: %.1f days ; sd: %.1f days",
      si_dist, si_mean, si_sd
    )
  )
```

# Growth rate ($r$) and reproduction number ($R$)

```{r}
last_date &lt;- dat %&gt;%
  pull(date) %&gt;%
  max()

# version using keep_first and keep_last from i2extras
days_to_keep &lt;- params$incomplete_days + params$r_estim_window
i_recent &lt;- dat_raw %&gt;%
  incidence("date",
    counts = count_var,
    groups = group_var
  ) %&gt;%
  keep_last(days_to_keep) %&gt;% # keep data for fitting
  keep_first(params$r_estim_window) # remove incomplete data
```

```{r}
dat_i_day &lt;- dat_raw %&gt;%
  incidence("date",
    interval = "daily",
    counts = count_var,
    groups = group_var
  ) %&gt;%
  keep_first(n_distinct(.$date_index) - params$incomplete_days)
```

```{r, child=paste0("rmdchunks/", params$rt_estimator, ".Rmd")}
```

```{r}
grateful::cite_packages(output = "paragraph", out.dir = ".", pkgs = "Session")
```</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Hugo Gruson, Thibaut Jombart, data.org.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
